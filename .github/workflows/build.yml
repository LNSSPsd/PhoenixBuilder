name: Build binaries

on:
  push:
    branches: [ epsilon ,wayland-v8go]
    paths:
      - "version"
      - "fyne-gui/version"
      - ".github/workflows/build.yml"

jobs:
  linux-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16
    - name: Set up NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r20b
        add-to-path: false
    - name: Move NDK
      run: mv ${{ steps.setup-ndk.outputs.ndk-path }} ${HOME}/android-ndk-r20b
    - name: Install compilers
      run: |
        sudo apt install gcc-mingw-w64-i686 gcc-mingw-w64-x86-64 gcc gcc-aarch64-linux-gnu libgl1-mesa-dev xorg-dev -y
    - name: Setup theos's dependencies
      run: sudo apt install fakeroot git perl unzip build-essential libtinfo5 libplist-utils brotli
    - name: Clone theos
      uses: actions/checkout@v2
      with:
        submodules: 'recursive'
        repository: 'theos/theos'
        path: 'theos'
    - name: Pre-Build & configure go-raknet
      run: |
        make clean
        chmod 0644 ~/go/pkg/mod/github.com/sandertv/go-raknet@v1.9.1/conn.go
        sed "s/urrentProtocol byte = 10/urrentProtocol byte = 8/g" ~/go/pkg/mod/github.com/sandertv/go-raknet@v1.9.1/conn.go>~/conn.go
        cp -f ~/conn.go ~/go/pkg/mod/github.com/sandertv/go-raknet@v1.9.1/conn.go
    - name: Build
      run: |
        export THEOS=~/theos
        make
